<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/homepage.css">
</head>
<body>
  <main class="container narrow">
    <header class="page-header">
      <div>
        <p class="eyebrow">TRIP</p>
        <h1><%= trip ? (trip.topic || trip.title) : '여행 정보 없음' %></h1>
        <p class="muted"><%= trip ? ((trip.destination || trip.country) + ' · ' + (trip.headcount ? trip.headcount + '명' : '인원 미정') + ' · ' + trip.budget) : '' %></p>
      </div>
      <div class="hero__actions" style="gap:8px;">
        <a class="btn ghost" href="/">목록으로</a>
        <% if (trip) { %>
          <button class="btn primary" id="join-btn" type="button" data-author-email="<%= trip.authorEmail || '' %>">참여 요청</button>
        <% } %>
      </div>
    </header>

    <% if (message) { %>
      <div class="alert"><%= message %></div>
    <% } %>

    <% if (trip) { %>
      <section class="trip-meta">
        <div class="pill"><%= trip.destination || trip.country %></div>
        <div class="tags">
          <% (trip.places && trip.places.length ? trip.places : []).forEach(place => { %>
            <span class="tag">#<%= place %></span>
          <% }) %>
        </div>
        <div class="muted small">작성자 <strong><%= trip.authorName || trip.author || '익명' %></strong> · <%= trip.createdAt.toLocaleString('ko-KR') %></div>
      </section>

      <article class="trip-body">
        <p><%= trip.description %></p>
      </article>
    <% } %>
  </main>
  <script type="module" src="/firebase-client.js"></script>
  <% if (trip) { %>
  <script>
    (function() {
      const joinBtn = document.getElementById('join-btn');
      if (!joinBtn) return;

      // 본인 게시글이면 참여 버튼 숨김
      try {
        const raw = localStorage.getItem('currentUser');
        if (raw) {
          const user = JSON.parse(raw);
          const authorEmail = joinBtn.getAttribute('data-author-email');
          if (authorEmail && user.email && user.email === authorEmail) {
            joinBtn.style.display = 'none';
            return;
          }
        }
      } catch (_) {}

      joinBtn.addEventListener('click', async () => {
        try {
          const raw = localStorage.getItem('currentUser');
          if (!raw) {
            alert('로그인 후 참여 요청을 보낼 수 있습니다.');
            window.location.href = '/login';
            return;
          }
          const user = JSON.parse(raw);
          const message = prompt('참여 요청 메모를 남겨주세요 (선택 사항)', '');
          joinBtn.disabled = true;
          joinBtn.textContent = '요청 전송 중...';
          const res = await fetch('/trips/<%= trip.id %>/request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              requesterName: user.name || '익명',
              requesterEmail: user.email || '',
              message: message || ''
            })
          });
          if (res.ok) {
            alert('참여 요청이 전송되었습니다.');
          } else {
            const data = await res.json();
            alert(data.error || '요청 전송 중 오류가 발생했습니다.');
          }
        } catch (e) {
          alert('요청을 처리할 수 없습니다.');
        } finally {
          joinBtn.disabled = false;
          joinBtn.textContent = '참여 요청';
        }
      });
    })();
  </script>
  <% } %>
</body>
</html>
